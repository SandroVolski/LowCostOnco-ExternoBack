import { Request, Response } from 'express';
import { query } from '../config/database';
import { ApiResponse } from '../types/api';

interface AuthRequest extends Request {
  user?: {
    id: number;
    tipo: 'clinica' | 'operadora' | 'admin';
    clinicaId?: number;
    operadoraId?: number;
    role?: string;
  };
}

export class DashboardController {
  // GET /api/dashboard/metrics - M√©tricas do dashboard
  static async getMetrics(req: AuthRequest, res: Response): Promise<void> {
    try {
      console.log('üîß Buscando m√©tricas do dashboard...');
      
      // Dados simulados para evitar erros SQL
      const metrics = {
        totalClinicas: 5,
        totalSolicitacoes: 45,
        solicitacoesHoje: 2,
        solicitacoesSemana: 15,
        solicitacoesMes: 45,
        totalPacientes: 30,
        solicitacoesAutorizadas: 35,
        solicitacoesNegadas: 10,
        solicitacoesEmProcessamento: 8,
        solicitacoesEmAnalise: 5,
        prazoMedioAutorizacao: 3.5,
        taxaAprovacao: 77.8,
        tempoMedioResposta: 2.1
      };
      
      console.log('‚úÖ M√©tricas carregadas:', metrics);
      
      const response: ApiResponse = {
        success: true,
        message: 'M√©tricas obtidas com sucesso',
        data: metrics
      };
      
      res.json(response);
      
    } catch (error) {
      console.error('‚ùå Erro ao buscar m√©tricas:', error);
      const response: ApiResponse = {
        success: false,
        message: 'Erro ao buscar m√©tricas',
        error: error instanceof Error ? error.message : 'Erro desconhecido'
      };
      res.status(500).json(response);
    }
  }

  // GET /api/dashboard/charts - Dados para gr√°ficos
  static async getChartsData(req: AuthRequest, res: Response): Promise<void> {
    try {
      console.log('üîß Buscando dados para gr√°ficos...');
      
      // Dados simulados para gr√°ficos
      const chartsData = {
        chartData: [
          { mes: 'Jan', solicitacoes: 12 },
          { mes: 'Fev', solicitacoes: 18 },
          { mes: 'Mar', solicitacoes: 15 },
          { mes: 'Abr', solicitacoes: 22 },
          { mes: 'Mai', solicitacoes: 28 },
          { mes: 'Jun', solicitacoes: 35 }
        ],
        activePrinciples: [
          { name: 'Paclitaxel', count: 15 },
          { name: 'Carboplatina', count: 12 },
          { name: 'Cisplatina', count: 8 },
          { name: 'Doxorrubicina', count: 6 },
          { name: '5-Fluorouracila', count: 4 }
        ]
      };
      
      console.log('‚úÖ Dados de gr√°ficos carregados');
      
      const response: ApiResponse = {
        success: true,
        message: 'Dados de gr√°ficos obtidos com sucesso',
        data: chartsData
      };
      
      res.json(response);
      
    } catch (error) {
      console.error('‚ùå Erro ao buscar dados de gr√°ficos:', error);
      const response: ApiResponse = {
        success: false,
        message: 'Erro ao buscar dados de gr√°ficos',
        error: error instanceof Error ? error.message : 'Erro desconhecido'
      };
      res.status(500).json(response);
    }
  }

  // GET /api/dashboard/performance - Performance das cl√≠nicas
  static async getClinicasPerformance(req: AuthRequest, res: Response): Promise<void> {
    try {
      console.log('üîß Buscando performance das cl√≠nicas...');
      
      // Dados simulados para performance
      const performance = [
        {
          name: 'Cl√≠nica OncoLife',
          solicitacoes: 25,
          aprovacoes: 20,
          tempo_medio: 2.5
        },
        {
          name: 'Centro de Oncologia SP',
          solicitacoes: 18,
          aprovacoes: 15,
          tempo_medio: 3.2
        },
        {
          name: 'Instituto do C√¢ncer',
          solicitacoes: 12,
          aprovacoes: 10,
          tempo_medio: 2.8
        }
      ];
      
      console.log('‚úÖ Performance das cl√≠nicas carregada');
      
      const response: ApiResponse = {
        success: true,
        message: 'Performance das cl√≠nicas obtida com sucesso',
        data: performance
      };
      
      res.json(response);
      
    } catch (error) {
      console.error('‚ùå Erro ao buscar performance das cl√≠nicas:', error);
      const response: ApiResponse = {
        success: false,
        message: 'Erro ao buscar performance das cl√≠nicas',
        error: error instanceof Error ? error.message : 'Erro desconhecido'
      };
      res.status(500).json(response);
    }
  }
}