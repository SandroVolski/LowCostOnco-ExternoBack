// src/controllers/solicitacaoController.ts - ATUALIZADO COM LOGO

import { Request, Response } from 'express';
import { SolicitacaoAutorizacaoModel } from '../models/SolicitacaoAutorizacao';
import { ClinicaModel } from '../models/Clinica';
import { SolicitacaoCreateInput, SolicitacaoUpdateInput } from '../types/solicitacao';
import { ApiResponse } from '../types';
import { generateAuthorizationPDF } from '../utils/pdfGenerator';

export class SolicitacaoController {
  
  // POST /api/solicitacoes - Criar nova solicita√ß√£o
  static async create(req: Request, res: Response): Promise<void> {
    try {
      const dadosSolicitacao: SolicitacaoCreateInput = req.body;
      
      // Valida√ß√µes b√°sicas
      if (!dadosSolicitacao.hospital_nome || !dadosSolicitacao.cliente_nome || 
          !dadosSolicitacao.diagnostico_cid || !dadosSolicitacao.medicamentos_antineoplasticos) {
        const response: ApiResponse = {
          success: false,
          message: 'Campos obrigat√≥rios: hospital_nome, cliente_nome, diagnostico_cid, medicamentos_antineoplasticos'
        };
        res.status(400).json(response);
        return;
      }
      
      // Garantir que a data de solicita√ß√£o seja hoje se n√£o fornecida
      if (!dadosSolicitacao.data_solicitacao) {
        dadosSolicitacao.data_solicitacao = new Date().toISOString().split('T')[0];
      }
      
      // Garantir que clinica_id seja fornecido (pode vir do token de autentica√ß√£o)
      if (!dadosSolicitacao.clinica_id) {
        dadosSolicitacao.clinica_id = 1; // Valor padr√£o para testes
      }
      
      const novaSolicitacao = await SolicitacaoAutorizacaoModel.create(dadosSolicitacao);
      
      const response: ApiResponse = {
        success: true,
        message: 'Solicita√ß√£o criada com sucesso',
        data: novaSolicitacao
      };
      
      res.status(201).json(response);
    } catch (error) {
      console.error('Erro ao criar solicita√ß√£o:', error);
      const response: ApiResponse = {
        success: false,
        message: 'Erro ao criar solicita√ß√£o',
        error: error instanceof Error ? error.message : 'Erro desconhecido'
      };
      res.status(500).json(response);
    }
  }
  
  // GET /api/solicitacoes/:id - Buscar solicita√ß√£o por ID
  static async show(req: Request, res: Response): Promise<void> {
    try {
      const id = parseInt(req.params.id);
      
      if (isNaN(id)) {
        const response: ApiResponse = {
          success: false,
          message: 'ID inv√°lido'
        };
        res.status(400).json(response);
        return;
      }
      
      const solicitacao = await SolicitacaoAutorizacaoModel.findById(id);
      
      if (!solicitacao) {
        const response: ApiResponse = {
          success: false,
          message: 'Solicita√ß√£o n√£o encontrada'
        };
        res.status(404).json(response);
        return;
      }
      
      const response: ApiResponse = {
        success: true,
        message: 'Solicita√ß√£o encontrada com sucesso',
        data: solicitacao
      };
      
      res.json(response);
    } catch (error) {
      console.error('Erro ao buscar solicita√ß√£o:', error);
      const response: ApiResponse = {
        success: false,
        message: 'Erro ao buscar solicita√ß√£o',
        error: error instanceof Error ? error.message : 'Erro desconhecido'
      };
      res.status(500).json(response);
    }
  }
  
  // GET /api/solicitacoes/clinica/:clinicaId - Buscar solicita√ß√µes por cl√≠nica
  static async getByClinica(req: Request, res: Response): Promise<void> {
    try {
      const clinicaId = parseInt(req.params.clinicaId);
      const page = parseInt(req.query.page as string) || 1;
      const limit = parseInt(req.query.limit as string) || 10;
      
      if (isNaN(clinicaId)) {
        const response: ApiResponse = {
          success: false,
          message: 'ID da cl√≠nica inv√°lido'
        };
        res.status(400).json(response);
        return;
      }
      
      const result = await SolicitacaoAutorizacaoModel.findByClinicaId(clinicaId, { page, limit });
      
      const response: ApiResponse = {
        success: true,
        message: 'Solicita√ß√µes da cl√≠nica encontradas com sucesso',
        data: result
      };
      
      res.json(response);
    } catch (error) {
      console.error('Erro ao buscar solicita√ß√µes da cl√≠nica:', error);
      const response: ApiResponse = {
        success: false,
        message: 'Erro ao buscar solicita√ß√µes da cl√≠nica',
        error: error instanceof Error ? error.message : 'Erro desconhecido'
      };
      res.status(500).json(response);
    }
  }
  
  // ‚úÖ GET /api/solicitacoes/:id/pdf - Gerar PDF com suporte para visualiza√ß√£o
  static async generatePDF(req: Request, res: Response): Promise<void> {
    try {
      const id = parseInt(req.params.id);
      const isView = req.query.view === 'true';  // üÜï Par√¢metro para visualiza√ß√£o
      const isInline = req.query.inline === 'true';  // üÜï Par√¢metro para inline
      
      if (isNaN(id)) {
        const response: ApiResponse = {
          success: false,
          message: 'ID inv√°lido'
        };
        res.status(400).json(response);
        return;
      }
      
      console.log('üîß Iniciando gera√ß√£o de PDF para solicita√ß√£o:', id);
      console.log('üìã Modo:', isView ? 'Visualiza√ß√£o' : 'Download');
      console.log('üìã Inline:', isInline ? 'Sim' : 'N√£o');
      
      // Buscar a solicita√ß√£o
      const solicitacao = await SolicitacaoAutorizacaoModel.findById(id);
      
      if (!solicitacao) {
        const response: ApiResponse = {
          success: false,
          message: 'Solicita√ß√£o n√£o encontrada'
        };
        res.status(404).json(response);
        return;
      }
      
      console.log('‚úÖ Solicita√ß√£o encontrada:', {
        id: solicitacao.id,
        clinica_id: solicitacao.clinica_id,
        cliente: solicitacao.cliente_nome
      });
      
      // ‚úÖ BUSCAR DADOS DA CL√çNICA E LOGO
      let clinicLogo = '';
      try {
        console.log('üîß Buscando dados da cl√≠nica ID:', solicitacao.clinica_id);
        const clinicProfile = await ClinicaModel.findById(solicitacao.clinica_id);
        
        if (clinicProfile?.clinica?.logo_url) {
          clinicLogo = clinicProfile.clinica.logo_url;
          console.log('‚úÖ Logo da cl√≠nica encontrada:', clinicLogo.substring(0, 50) + '...');
        } else {
          console.log('‚ö†Ô∏è  Logo da cl√≠nica n√£o encontrada');
        }
      } catch (logoError) {
        console.warn('‚ö†Ô∏è  Erro ao buscar logo da cl√≠nica:', logoError);
        // Continua sem a logo
      }
      
      // ‚úÖ GERAR O PDF COM LOGO
      console.log('üé® Gerando PDF moderno...');
      const pdfBuffer = await generateAuthorizationPDF(solicitacao, clinicLogo);
      
      // üÜï CONFIGURAR HEADERS BASEADO NO MODO
      const fileName = `autorizacao_tratamento_${id}_${new Date().toISOString().split('T')[0]}.pdf`;
      
      // Headers b√°sicos
      res.setHeader('Content-Type', 'application/pdf');
      res.setHeader('Content-Length', pdfBuffer.length);
      res.setHeader('Cache-Control', 'no-cache, no-store, must-revalidate');
      res.setHeader('Pragma', 'no-cache');
      res.setHeader('Expires', '0');
      
      // üÜï CONFIGURAR MODO DE EXIBI√á√ÉO
      if (isView || isInline) {
        // Para visualiza√ß√£o inline no browser
        res.setHeader('Content-Disposition', `inline; filename="${fileName}"`);
        // ‚úÖ CORRE√á√ÉO: Remover headers CSP problem√°ticos para iframe
        res.removeHeader('X-Frame-Options');
        res.removeHeader('Content-Security-Policy');
        console.log('üëÅÔ∏è  Configurado para visualiza√ß√£o inline');
      } else {
        // Para download tradicional
        res.setHeader('Content-Disposition', `attachment; filename="${fileName}"`);
        console.log('üíæ Configurado para download');
      }
      
      // Enviar o PDF
      res.send(pdfBuffer);
      
      console.log('‚úÖ PDF enviado com sucesso! Tamanho:', (pdfBuffer.length / 1024).toFixed(2), 'KB');
      console.log('üìã Modo final:', isView ? 'Visualiza√ß√£o' : 'Download');
      
    } catch (error) {
      console.error('‚ùå Erro ao gerar PDF:', error);
      const response: ApiResponse = {
        success: false,
        message: 'Erro ao gerar PDF',
        error: error instanceof Error ? error.message : 'Erro desconhecido'
      };
      res.status(500).json(response);
    }
  }
  
  // PUT /api/solicitacoes/:id/status - Atualizar status da solicita√ß√£o
  static async updateStatus(req: Request, res: Response): Promise<void> {
    try {
      const id = parseInt(req.params.id);
      const dadosAtualizacao: SolicitacaoUpdateInput = req.body;
      
      if (isNaN(id)) {
        const response: ApiResponse = {
          success: false,
          message: 'ID inv√°lido'
        };
        res.status(400).json(response);
        return;
      }
      
      const solicitacaoAtualizada = await SolicitacaoAutorizacaoModel.updateStatus(id, dadosAtualizacao);
      
      if (!solicitacaoAtualizada) {
        const response: ApiResponse = {
          success: false,
          message: 'Solicita√ß√£o n√£o encontrada'
        };
        res.status(404).json(response);
        return;
      }
      
      const response: ApiResponse = {
        success: true,
        message: 'Status da solicita√ß√£o atualizado com sucesso',
        data: solicitacaoAtualizada
      };
      
      res.json(response);
    } catch (error) {
      console.error('Erro ao atualizar status da solicita√ß√£o:', error);
      const response: ApiResponse = {
        success: false,
        message: 'Erro ao atualizar status da solicita√ß√£o',
        error: error instanceof Error ? error.message : 'Erro desconhecido'
      };
      res.status(500).json(response);
    }
  }
  
  // DELETE /api/solicitacoes/:id - Deletar solicita√ß√£o
  static async destroy(req: Request, res: Response): Promise<void> {
    try {
      const id = parseInt(req.params.id);
      
      if (isNaN(id)) {
        const response: ApiResponse = {
          success: false,
          message: 'ID inv√°lido'
        };
        res.status(400).json(response);
        return;
      }
      
      const deleted = await SolicitacaoAutorizacaoModel.delete(id);
      
      if (deleted) {
        const response: ApiResponse = {
          success: true,
          message: 'Solicita√ß√£o deletada com sucesso'
        };
        res.json(response);
      } else {
        const response: ApiResponse = {
          success: false,
          message: 'Solicita√ß√£o n√£o encontrada'
        };
        res.status(404).json(response);
      }
    } catch (error) {
      console.error('Erro ao deletar solicita√ß√£o:', error);
      const response: ApiResponse = {
        success: false,
        message: 'Erro ao deletar solicita√ß√£o',
        error: error instanceof Error ? error.message : 'Erro desconhecido'
      };
      res.status(500).json(response);
    }
  }
  
  // GET /api/solicitacoes/status/:status - Buscar solicita√ß√µes por status
  static async getByStatus(req: Request, res: Response): Promise<void> {
    try {
      const status = req.params.status;
      
      if (!['pendente', 'aprovada', 'rejeitada', 'em_analise'].includes(status)) {
        const response: ApiResponse = {
          success: false,
          message: 'Status inv√°lido'
        };
        res.status(400).json(response);
        return;
      }
      
      const solicitacoes = await SolicitacaoAutorizacaoModel.findByStatus(status);
      
      const response: ApiResponse = {
        success: true,
        message: `Solicita√ß√µes com status ${status} encontradas com sucesso`,
        data: solicitacoes
      };
      
      res.json(response);
    } catch (error) {
      console.error('Erro ao buscar solicita√ß√µes por status:', error);
      const response: ApiResponse = {
        success: false,
        message: 'Erro ao buscar solicita√ß√µes por status',
        error: error instanceof Error ? error.message : 'Erro desconhecido'
      };
      res.status(500).json(response);
    }
  }

  // GET /api/solicitacoes - Listar todas as solicita√ß√µes
  static async index(req: Request, res: Response): Promise<void> {
    try {
      const page = parseInt(req.query.page as string) || 1;
      const limit = parseInt(req.query.limit as string) || 10;
      const clinicaId = req.query.clinica_id ? parseInt(req.query.clinica_id as string) : null;
      
      let result;
      
      if (clinicaId) {
        result = await SolicitacaoAutorizacaoModel.findByClinicaId(clinicaId, { page, limit });
      } else {
        // Implementar m√©todo para listar todas se necess√°rio
        result = await SolicitacaoAutorizacaoModel.findByClinicaId(1, { page, limit }); // Tempor√°rio
      }
      
      const response: ApiResponse = {
        success: true,
        message: 'Solicita√ß√µes encontradas com sucesso',
        data: result
      };
      
      res.json(response);
    } catch (error) {
      console.error('Erro ao listar solicita√ß√µes:', error);
      const response: ApiResponse = {
        success: false,
        message: 'Erro ao listar solicita√ß√µes',
        error: error instanceof Error ? error.message : 'Erro desconhecido'
      };
      res.status(500).json(response);
    }
  }
}